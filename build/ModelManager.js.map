{"version":3,"file":"ModelManager.js","sourceRoot":"","sources":["../src/ModelManager.ts"],"names":[],"mappings":"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","sourcesContent":["import { DownloadProgressEvent } from \"./ExpoLlmMediapipe.types\";\nimport ExpoLlmMediapipe from \"./ExpoLlmMediapipeModule\";\n\nexport interface ModelInfo {\n  name: string;\n  url: string;\n  size?: number;\n  status: \"not_downloaded\" | \"downloading\" | \"downloaded\" | \"error\";\n  progress?: number;\n  error?: string;\n}\n\nexport interface DownloadOptions {\n  overwrite?: boolean;\n  headers?: Record<string, string>;\n  timeout?: number;\n}\n\n/**\n * ModelManager is a singleton class that manages the lifecycle of models.\n * It handles downloading, deleting, and checking the status of models.\n * It also provides a way to listen for model status changes.\n */\nexport class ModelManager {\n  private models: Map<string, ModelInfo> = new Map();\n  private listeners: ((models: Map<string, ModelInfo>) => void)[] = [];\n  private downloadSubscription?: { remove: () => void };\n\n  constructor() {\n    // Set up download progress listener\n    this.downloadSubscription = ExpoLlmMediapipe.addListener(\n      \"downloadProgress\",\n      this.handleDownloadProgress,\n    );\n  }\n\n  private handleDownloadProgress = (event: DownloadProgressEvent) => {\n    const { modelName, progress, status, error } = event;\n\n    // Update model info\n    const model = this.models.get(modelName);\n    if (model) {\n      model.status =\n        status === \"completed\"\n          ? \"downloaded\"\n          : status === \"error\"\n            ? \"error\"\n            : status === \"downloading\"\n              ? \"downloading\"\n              : \"not_downloaded\";\n\n      if (progress !== undefined) {\n        model.progress = progress;\n      }\n\n      if (error) {\n        model.error = error;\n      }\n\n      // Save updated model info\n      this.models.set(modelName, model);\n\n      // Notify listeners\n      this.notifyListeners();\n    }\n  };\n\n  /**\n   * Registers a model with the manager.\n   * @param name - The name of the model.\n   * @param url - The URL to download the model from.\n   */\n  public registerModel(name: string, url: string): void {\n    if (!this.models.has(name)) {\n      this.models.set(name, {\n        name,\n        url,\n        status: \"not_downloaded\",\n      });\n\n      // Check if it's already downloaded\n      this.checkModelStatus(name);\n    }\n  }\n\n  private async checkModelStatus(modelName: string): Promise<void> {\n    try {\n      const isDownloaded = await ExpoLlmMediapipe.isModelDownloaded(modelName);\n      const model = this.models.get(modelName);\n\n      if (model) {\n        model.status = isDownloaded ? \"downloaded\" : \"not_downloaded\";\n        this.models.set(modelName, model);\n        this.notifyListeners();\n      }\n    } catch (error) {\n      console.error(`Error checking model status: ${error}`);\n    }\n  }\n\n  /**\n   * Downloads a model.\n   * @param modelName - The name of the model to download.\n   * @param options - Optional download options.\n   * @returns A promise that resolves to true if the download was successful.\n   */\n  public async downloadModel(\n    modelName: string,\n    options?: DownloadOptions,\n  ): Promise<boolean> {\n    const model = this.models.get(modelName);\n    if (!model) {\n      throw new Error(`Model ${modelName} is not registered`);\n    }\n\n    try {\n      // Update status to downloading\n      model.status = \"downloading\";\n      model.progress = 0;\n      this.models.set(modelName, model);\n      this.notifyListeners();\n\n      // Prepare download options with defaults\n      const downloadOptions = {\n        overwrite: false,\n        ...options,\n      };\n\n      // Start download with options\n      const result = await ExpoLlmMediapipe.downloadModel(\n        model.url,\n        modelName,\n        downloadOptions,\n      );\n      return result;\n    } catch (error) {\n      // Update status to error\n      model.status = \"error\";\n      // model.error = error.message;\n      this.models.set(modelName, model);\n      this.notifyListeners();\n      throw error;\n    }\n  }\n\n  /**\n   * Cancels a download in progress.\n   * @param modelName - The name of the model to cancel the download for.\n   * @returns A promise that resolves to true if the cancellation was successful.\n   */\n  public async cancelDownload(modelName: string): Promise<boolean> {\n    return await ExpoLlmMediapipe.cancelDownload(modelName);\n  }\n\n  /**\n   * Deletes a model from the manager.\n   * @param modelName - The name of the model to delete.\n   * @returns A promise that resolves to true if the deletion was successful.\n   */\n  public async deleteModel(modelName: string): Promise<boolean> {\n    const result = await ExpoLlmMediapipe.deleteDownloadedModel(modelName);\n    if (result) {\n      const model = this.models.get(modelName);\n      if (model) {\n        model.status = \"not_downloaded\";\n        model.progress = undefined;\n        this.models.set(modelName, model);\n        this.notifyListeners();\n      }\n    }\n    return result;\n  }\n\n  /**\n   * Loads a downloaded model.\n   * @param modelName - The name of the model to load.\n   * @param maxTokens - Optional maximum number of tokens for the model.\n   * @param topK - Optional top K value for the model.\n   * @param temperature - Optional temperature value for the model.\n   * @param randomSeed - Optional random seed for the model.\n   * @returns A promise that resolves to the handle of the loaded model.\n   */\n  public async getDownloadedModels(): Promise<string[]> {\n    return await ExpoLlmMediapipe.getDownloadedModels();\n  }\n\n  /**\n   * Loads a downloaded model.\n   * @param modelName - The name of the model to load.\n   * @param maxTokens - Optional maximum number of tokens for the model.\n   * @param topK - Optional top K value for the model.\n   * @param temperature - Optional temperature value for the model.\n   * @param randomSeed - Optional random seed for the model.\n   * @returns A promise that resolves to the handle of the loaded model.\n   */\n  public async loadDownloadedModel(\n    modelName: string,\n    maxTokens?: number,\n    topK?: number,\n    temperature?: number,\n    randomSeed?: number,\n  ): Promise<number> {\n    return await ExpoLlmMediapipe.createModelFromDownloaded(\n      modelName,\n      maxTokens,\n      topK,\n      temperature,\n      randomSeed,\n    );\n  }\n\n  /**\n   * Gets the information of a specific model.\n   * @param modelName - The name of the model to get information about.\n   * @returns The model information or undefined if the model is not found.\n   */\n  public getModelInfo(modelName: string): ModelInfo | undefined {\n    return this.models.get(modelName);\n  }\n\n  /**\n   * Gets all registered models.\n   * @returns An array of all registered models.\n   */\n  public getAllModels(): ModelInfo[] {\n    return Array.from(this.models.values());\n  }\n\n  /**\n   * Adds a listener for model updates.\n   * @param callback - The callback to invoke when models are updated.\n   * @returns A function to unsubscribe the listener.\n   */\n  public addListener(\n    callback: (models: Map<string, ModelInfo>) => void,\n  ): () => void {\n    this.listeners.push(callback);\n\n    // Return unsubscribe function\n    return () => {\n      this.listeners = this.listeners.filter(\n        (listener) => listener !== callback,\n      );\n    };\n  }\n\n  private notifyListeners(): void {\n    this.listeners.forEach((listener) => {\n      listener(this.models);\n    });\n  }\n\n  /**\n   * Cleans up the ModelManager, removing all listeners and subscriptions.\n   */\n  public cleanup(): void {\n    if (this.downloadSubscription) {\n      this.downloadSubscription.remove();\n    }\n\n    this.listeners = [];\n  }\n}\n\n// Export a singleton instance\nexport const modelManager = new ModelManager();\n\n// Also export the class for those who need multiple instances\nexport default ModelManager;\n"]}